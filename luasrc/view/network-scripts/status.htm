<%+header%>
<style>
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
.status-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.status-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f5f5f5}
.quality-bar{width:100%;height:10px;background:#eee;border-radius:5px;overflow:hidden;margin-top:5px}
.quality-fill{height:100%;transition:width .3s}
.btn-action{padding:8px 15px;margin:5px;cursor:pointer;border:none;border-radius:5px;color:#fff}
.btn-bb{background:#3498db}.btn-cpe{background:#9b59b6}.btn-unlock{background:#27ae60}
</style>
<div class="cbi-map">
<h2>ğŸ“¡ <%:Network Status Monitor%></h2>
<div class="status-grid">
 <div class="status-card"><h3>ğŸ“Š <%:Basic Status%></h3>
  <div class="status-item"><span><%:Policy%></span><b id="st_mode">...</b></div>
  <div class="status-item"><span><%:Gateway%></span><b id="st_gw">...</b></div>
  <div class="status-item"><span><%:Internet%></span><b id="st_net">...</b></div>
  <div class="status-item"><span><%:Auth%></span><b id="st_auth">...</b></div>
  <div class="status-item"><span><%:Lock%></span><b id="lock_status">...</b></div>
 </div>
 <div class="status-card"><h3>ğŸ“¶ <%:Broadband%></h3>
  <div class="status-item"><span><%:Latency/Loss%></span><b id="bb_stat">...</b></div>
  <div class="quality-bar"><div class="quality-fill" id="bb_bar" style="width:0%"></div></div>
 </div>
 <div class="status-card"><h3>ğŸ“± CPE</h3>
  <div class="status-item"><span><%:Latency/Loss%></span><b id="cpe_stat">...</b></div>
  <div class="quality-bar"><div class="quality-fill" id="cpe_bar" style="width:0%"></div></div>
 </div>
</div>
<div style="margin:20px 0">
 <button class="btn-action btn-bb" onclick="lock('broadband',2)"><%:Lock Broadband 2h%></button>
 <button class="btn-action btn-cpe" onclick="lock('cpe',2)"><%:Lock CPE 2h%></button>
 <button class="btn-action btn-unlock" onclick="lock('off',0)"><%:Unlock%></button>
</div>
<script>
const api='<%=luci.dispatcher.build_url("admin/services/network-scripts/api")%>';
function lock(m,d){fetch(api+'/lock?mode='+m+'&duration='+d).then(()=>update())}
function update(){
 fetch(api+'/status').then(r=>r.json()).then(d=>{
  document.getElementById('st_mode').innerHTML=d.mode;
  document.getElementById('st_gw').innerHTML=d.gateway||'N/A';
  document.getElementById('st_net').innerHTML=d.internet=='online'?'<span style="color:#27ae60">âœ… Online</span>':'<span style="color:#e74c3c">âŒ Offline</span>';
  var authMap={authenticated:'<span style="color:#27ae60">âœ… Authenticated</span>',need_auth:'<span style="color:#f39c12">âš ï¸ Need Auth</span>',offline:'<span style="color:#e74c3c">âŒ Offline</span>'};
  document.getElementById('st_auth').innerHTML=authMap[d.auth_status]||d.auth_status;
  document.getElementById('lock_status').innerHTML=d.lock_mode=='off'?'Unlocked':'Locked: '+d.lock_mode;
 });
 fetch(api+'/quality').then(r=>r.json()).then(d=>{
  if(d.broadband.status!='offline'){
   document.getElementById('bb_stat').innerText=d.broadband.latency+'ms / '+d.broadband.packet_loss+'%';
   document.getElementById('bb_bar').style.width=d.broadband.score+'%';
   document.getElementById('bb_bar').style.background=d.broadband.score>60?'#27ae60':'#e74c3c';
  }else{document.getElementById('bb_stat').innerText='Offline';}
  if(d.cpe.status!='offline'){
   document.getElementById('cpe_stat').innerText=d.cpe.latency+'ms / '+d.cpe.packet_loss+'%';
   document.getElementById('cpe_bar').style.width=d.cpe.score+'%';
   document.getElementById('cpe_bar').style.background=d.cpe.score>60?'#27ae60':'#e74c3c';
  }else{document.getElementById('cpe_stat').innerText='Offline';}
 });
}
update();setInterval(update,5000);
</script>
</div>
<%+footer%>