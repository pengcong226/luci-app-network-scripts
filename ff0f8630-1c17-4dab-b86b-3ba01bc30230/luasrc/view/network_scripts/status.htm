<script type="text/javascript">//<![CDATA[
    var updateTimer = null;
    
    function updateStatus() {
        XHR.get('<%=luci.dispatcher.build_url("admin", "services", "network_scripts", "status")%>', null,
            function(x, data) {
                if (data) {
                    var gw = document.getElementById('ns_gateway');
                    var dev = document.getElementById('ns_device');
                    var mode = document.getElementById('ns_mode');
                    var lock = document.getElementById('ns_lock');
                    var auth = document.getElementById('ns_auth');
                    var update = document.getElementById('ns_update');
                    var status_icon = document.getElementById('ns_status_icon');
                    
                    if (gw) gw.innerHTML = data.gateway || '-';
                    if (dev) dev.innerHTML = data.device || '-';
                    
                    if (mode) {
                        var modeText = data.mode || 'unknown';
                        if (modeText.indexOf('broadband') !== -1) {
                            mode.innerHTML = '<span style="color:green;font-weight:bold">宽带优先</span>';
                        } else if (modeText.indexOf('cpe') !== -1) {
                            mode.innerHTML = '<span style="color:blue;font-weight:bold">CPE 备用</span>';
                        } else {
                            mode.innerHTML = modeText;
                        }
                    }
                    
                    if (lock) {
                        if (data.lock_mode === 'off') {
                            lock.innerHTML = '未锁定';
                        } else {
                            lock.innerHTML = '<span style="color:red;font-weight:bold">锁定: ' + data.lock_mode + '</span>';
                        }
                    }
                    
                    if (auth) auth.innerHTML = data.auth_status || '-';
                    
                    if (update) {
                        var date = new Date(data.updated_at * 1000);
                        update.innerHTML = date.toLocaleTimeString();
                    }
                    
                    if (status_icon) {
                        if (data.internet === 'online') {
                            status_icon.innerHTML = '<span style="color:green;font-size:20px">●</span> 在线';
                        } else {
                            status_icon.innerHTML = '<span style="color:red;font-size:20px">●</span> 离线';
                        }
                    }
                    
                    // 质量数据
                    if (data.quality) {
                        var q_bb = document.getElementById('ns_q_broadband');
                        var q_cpe = document.getElementById('ns_q_cpe');
                        
                        if (q_bb && data.quality.broadband) {
                            var q = data.quality.broadband;
                            if (q.status === 'online') {
                                q_bb.innerHTML = '延迟: ' + q.latency + 'ms | 丢包: ' + q.loss + '% | 分数: ' + q.score;
                            } else {
                                q_bb.innerHTML = '离线';
                            }
                        }
                        
                        if (q_cpe && data.quality.cpe) {
                            var q = data.quality.cpe;
                            if (q.status === 'online') {
                                q_cpe.innerHTML = '延迟: ' + q.latency + 'ms | 丢包: ' + q.loss + '% | 分数: ' + q.score;
                            } else {
                                q_cpe.innerHTML = '离线';
                            }
                        }
                    }
                }
            }
        );
        
        // 同时也拉取日志
        XHR.get('<%=luci.dispatcher.build_url("admin", "services", "network_scripts", "log")%>', null,
            function(x, data) {
                var logBox = document.getElementById('ns_log_box');
                if (logBox) {
                    logBox.value = data;
                    logBox.scrollTop = logBox.scrollHeight;
                }
            }
        );
    }
    
    function setLock(mode, duration) {
        var btn = document.getElementById('btn_lock_' + mode);
        if(btn) btn.disabled = true;
        
        XHR.post('<%=luci.dispatcher.build_url("admin", "services", "network_scripts", "lock")%>', 
            { mode: mode, duration: duration },
            function(x, data) {
                if(btn) btn.disabled = false;
                updateStatus();
            }
        );
    }
    
    // 页面加载完成后启动定时器
    window.onload = function() {
        updateStatus();
        updateTimer = setInterval(updateStatus, 3000);
    }
//]]></script>

<fieldset class="cbi-section">
    <legend>系统状态概览</legend>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px">
        <div style="width:48%; padding:10px; border:1px solid #ddd; border-radius:5px">
            <h3>当前连接</h3>
            <table width="100%" cellspacing="10">
                <tr><td width="30%">网络状态:</td><td id="ns_status_icon">-</td></tr>
                <tr><td>当前接口:</td><td id="ns_device">-</td></tr>
                <tr><td>当前网关:</td><td id="ns_gateway">-</td></tr>
                <tr><td>运行模式:</td><td id="ns_mode">-</td></tr>
                <tr><td>认证状态:</td><td id="ns_auth">-</td></tr>
                <tr><td>最后更新:</td><td id="ns_update">-</td></tr>
            </table>
        </div>
        
        <div style="width:48%; padding:10px; border:1px solid #ddd; border-radius:5px">
            <h3>快捷操作</h3>
            <div style="margin-bottom:10px">
                <strong>锁定线路:</strong><br/>
                <input type="button" class="cbi-button cbi-button-apply" value="锁定宽带 (1h)" onclick="setLock('broadband', 1)" />
                <input type="button" class="cbi-button cbi-button-apply" value="锁定 CPE (1h)" onclick="setLock('cpe', 1)" />
                <input type="button" class="cbi-button cbi-button-reset" value="解除锁定" onclick="setLock('off', 0)" />
            </div>
            <div>
                <strong>当前锁定:</strong> <span id="ns_lock">-</span>
            </div>
        </div>
    </div>
    
    <div style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:5px">
        <h3>线路质量</h3>
        <table width="100%">
            <tr><td width="20%"><strong>宽带:</strong></td><td id="ns_q_broadband">-</td></tr>
            <tr><td><strong>CPE:</strong></td><td id="ns_q_cpe">-</td></tr>
        </table>
    </div>
    
    <div>
        <h3>实时日志</h3>
        <textarea id="ns_log_box" style="width:100%; height:200px; font-family:monospace; font-size:12px; background:#f0f0f0; border:1px solid #ccc" readonly>加载中...</textarea>
    </div>
</fieldset>